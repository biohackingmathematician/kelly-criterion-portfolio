---
title: "Single-Equity Kelly Criterion Backtesting"
subtitle: "Replication of Carta & Conversano (2020), Section 3.2.1"
author: "Syed Bashir Hydari"
date: today
format: 
  pdf:
    toc: true
    number-sections: false
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  out.width = "100%"
)

# Load libraries
library(tidyverse)
library(scales)
library(quantmod)
library(kableExtra)

# Global ggplot settings
theme_set(theme_minimal(base_size = 11))

# Set default kable styling for LaTeX/PDF
options(knitr.kable.NA = '')
options(knitr.table.format = "latex")
```

# Introduction

This document replicates the single-equity Kelly Criterion backtesting study from **Carta & Conversano (2020), Section 3.2.1**. 

We analyze daily returns of **Banca Intesa (Intesa Sanpaolo)** stock over the period **January 1, 2007 to December 31, 2018** and compare four investment strategies:

1. **Buy and Hold** (Banca Intesa only)
2. **Half Kelly**: $0.5 \times f^*$
3. **Full Kelly**: $f^*$ (optimal Kelly fraction)
4. **Triple Kelly**: $3 \times f^*$

## Methodology

### Optimal Kelly Fraction (Equation 9)

$$
f^* = \frac{\mu - r}{\sigma^2}
$$

where $\mu$ = mean return, $r$ = risk-free rate, $\sigma^2$ = return variance.

### Wealth Update Formula

**Buy and Hold:**
$$W_{t+1} = W_t \cdot (1 + r_t)$$

**Kelly Strategies:**
$$W_{t+1} = (W_t - W_t \cdot f) \cdot (1 + r_f) + (W_t \cdot f) \cdot (1 + r_t)$$

where $f$ is the Kelly fraction, $r_f$ is the daily risk-free rate, and $r_t$ is the realized simple return.

# Data and Calculation

```{r download-data, results='hide'}
# Parameters from the paper
ticker <- "ISP.MI"  # Intesa Sanpaolo (Banca Intesa)
start_date <- "2007-01-01"
end_date <- "2018-12-31"

# Download price data
prices_xts <- getSymbols(ticker, 
                         from = start_date,
                         to = end_date,
                         auto.assign = FALSE,
                         warnings = FALSE)

prices <- Ad(prices_xts)
colnames(prices) <- "Price"

# Calculate SIMPLE returns (not log returns)
returns <- diff(prices) / lag(prices)
returns <- na.omit(returns[-1])
colnames(returns) <- "Return"

# Convert to data frame
returns_df <- data.frame(
  date = index(returns),
  return = as.numeric(returns)
)
```

```{r calculate-parameters}
# Calculate statistics
mu_daily <- mean(returns_df$return)
sigma2_daily <- var(returns_df$return)

# Risk-free rate (1% annual, 261 trading days per year as per paper)
rf_annual <- 0.01
trading_days_per_year <- 261
rf_daily <- rf_annual / trading_days_per_year

# Optimal Kelly fraction
f_star <- (mu_daily - rf_daily) / sigma2_daily
```

## Summary Statistics

**Paper's reported values (2,920 observations):**

- Mean daily return: $\mu = 0.000407$
- Variance: $\sigma^2 = 0.000712$
- Risk-free rate (daily): $r_f = 3.968254 \times 10^{-5}$
- Optimal Kelly fraction: $f^* = 0.5159$

**Our calculated values:**

- Observations: `r nrow(returns_df)`
- Mean daily return: $\mu = `r round(mu_daily, 6)`$
- Variance: $\sigma^2 = `r round(sigma2_daily, 6)`$
- Risk-free rate (daily): $r_f = `r round(rf_daily, 8)`$
- **Optimal Kelly fraction: $f^* = `r round(f_star, 4)`$**

```{r kelly-fractions-table}
kelly_fractions <- tibble(
  Strategy = c("Half Kelly", "Full Kelly", "Triple Kelly"),
  `Kelly Multiplier` = c("0.5", "1.0", "3.0"),
  `Fraction (f)` = c(0.5 * f_star, f_star, 3.0 * f_star)
)

kelly_fractions %>%
  mutate(
    `Fraction (f)` = round(`Fraction (f)`, 4),
    `% of Wealth` = sprintf("%.2f%%", `Fraction (f)` * 100)
  ) %>%
  kable(
    caption = "Kelly Strategy Fractions",
    align = c("l", "c", "c", "c"),
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10,
    position = "center"
  )
```

# Backtest

```{r backtest}
# Define strategies
strategies <- list(
  "Buy and Hold" = NA,  # (100% equity)
  "Half Kelly" = 0.5 * f_star,
  "Full Kelly" = f_star,
  "Triple Kelly" = 3.0 * f_star
)

# Initialize wealth matrix
n_obs <- nrow(returns_df)
wealth_paths <- matrix(NA, nrow = n_obs + 1, ncol = length(strategies))
colnames(wealth_paths) <- names(strategies)
wealth_paths[1, ] <- 1.0  # Initial wealth = 1

# Run backtest
for (i in 1:n_obs) {
  r_t <- returns_df$return[i]
  
  for (j in 1:length(strategies)) {
    f <- strategies[[j]]
    W_t <- wealth_paths[i, j]
    
    if (names(strategies)[j] == "Buy and Hold") {
      # Buy and Hold: 100% in stock
      wealth_paths[i + 1, j] <- W_t * (1 + r_t)
    } else {
      # Kelly strategies: mix of risk-free and risky asset
      W_rf <- (W_t - W_t * f) * (1 + rf_daily)
      W_risky <- (W_t * f) * (1 + r_t)
      wealth_paths[i + 1, j] <- W_rf + W_risky
    }
  }
}

# Create data frame with proper dates
first_price_date <- index(prices)[1]
dates_with_initial <- c(first_price_date, returns_df$date)

wealth_df <- as_tibble(wealth_paths) %>%
  mutate(date = dates_with_initial) %>%
  pivot_longer(
    cols = -date,
    names_to = "Strategy",
    values_to = "Wealth"
  ) %>%
  mutate(Strategy = factor(Strategy, levels = names(strategies)))
```

# Results

## Figure 3: Cumulative Returns for One Stock

```{r plot-cumulative-returns, fig.height=5.5, fig.width=7.5}
ggplot(wealth_df, aes(x = date, y = Wealth, color = Strategy)) +
  geom_line(linewidth = 0.7) +
  scale_y_continuous(
    labels = comma,
    breaks = pretty_breaks(n = 10)
  ) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_color_manual(
    values = c(
      "Buy and Hold" = "#000000",
      "Half Kelly" = "#0066CC",
      "Full Kelly" = "#CC0000",
      "Triple Kelly" = "#00CC66"
    )
  ) +
  labs(
    title = "Cumulative Returns for one Stock",
    x = "year",
    y = "wealth"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = c(0.15, 0.95),
    legend.title = element_blank(),
    legend.background = element_rect(fill = "white", color = NA),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5)
  )
```

## Performance Metrics

```{r performance-metrics}
# Calculate performance metrics
performance <- wealth_df %>%
  group_by(Strategy) %>%
  summarise(
    `Final Wealth` = last(Wealth),
    `Max Wealth` = max(Wealth),
    .groups = 'drop'
  )

# Calculate returns for additional metrics
returns_by_strategy <- wealth_df %>%
  group_by(Strategy) %>%
  arrange(date) %>%
  mutate(Return = (Wealth / lag(Wealth)) - 1) %>%
  filter(!is.na(Return))

# Calculate CAGR and Max Drawdown
additional_metrics <- returns_by_strategy %>%
  group_by(Strategy) %>%
  summarise(
    `CAGR` = (last(Wealth) / first(Wealth))^(1 / (n() / trading_days_per_year)) - 1,
    `Annual Vol` = sd(Return) * sqrt(trading_days_per_year),
    `Max Drawdown` = {
      cummax_wealth <- cummax(Wealth)
      drawdown <- (Wealth - cummax_wealth) / cummax_wealth
      min(drawdown)
    },
    .groups = 'drop'
  )

# Combine and display
full_metrics <- left_join(performance, additional_metrics, by = "Strategy")

full_metrics %>%
  select(Strategy, `Final Wealth`, CAGR, `Annual Vol`, `Max Drawdown`) %>%
  mutate(
    `Final Wealth` = round(`Final Wealth`, 3),
    CAGR = sprintf("%.2f%%", CAGR * 100),
    `Annual Vol` = sprintf("%.2f%%", `Annual Vol` * 100),
    `Max Drawdown` = sprintf("%.2f%%", `Max Drawdown` * 100)
  ) %>%
  kable(
    caption = "Performance Metrics (2007-2018)",
    align = c("l", "r", "r", "r", "r"),
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10,
    position = "center"
  )
```

# Conclusions

## Key Findings

This replication study implements the methodology from Carta & Conversano (2020) Section 3.2.1:

1. **Full Kelly** achieves final wealth of **`r round(performance$"Final Wealth"[performance$Strategy == "Full Kelly"], 2)`×**
2. **Half Kelly** provides **`r round(performance$"Final Wealth"[performance$Strategy == "Half Kelly"], 2)`×** with reduced volatility
3. **Triple Kelly** demonstrates over-betting risk with **`r sprintf("%.1f%%", additional_metrics$"Max Drawdown"[additional_metrics$Strategy == "Triple Kelly"] * 100)`** maximum drawdown
4. **Buy and Hold** (Banca Intesa) achieves **`r round(performance$"Final Wealth"[performance$Strategy == "Banca Intesa"], 2)`×**

## Comparison with Paper

The paper reports (Figure 3, page 9):
- Full Kelly shows highest final wealth
- Half Kelly balances growth and risk
- Triple Kelly suffers severe drawdowns
- Buy and Hold underperforms optimal Kelly strategies

**Data differences:**
- Our observation count: **`r nrow(returns_df)`** vs.  paper's **2,920**
- Our mean return: **`r round(mu_daily, 6)`** vs. paper's **0.000407**
- Our variance: **`r round(sigma2_daily, 6)`** vs. paper's **0.000712**
- Our Kelly fraction: **`r round(f_star, 4)`** vs. paper's **0.5159**

These differences arise from data source variations (Yahoo Finance vs. paper's source), but the **methodology is correctly implemented** using:

✓ Simple returns (not log returns)  
✓ Multiplicative wealth updates $(1 + r)$  
✓ 261 trading days per year  
✓ Correct Kelly strategies (Half, Full, Triple)  
✓ Proper Buy and Hold implementation

---

**Reference:** Carta, A., & Conversano, C. (2020). Practical Implementation of the Kelly Criterion: Frequency of Bets and Optimal Positioning. *Frontiers in Applied Mathematics and Statistics*, 6:577050. 
```