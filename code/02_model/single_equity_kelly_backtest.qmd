---
title: "Single-Equity Kelly Criterion Backtesting"
subtitle: "Replication of Carta & Conversano (2020)"
author: "Syed Bashir Hydari"
date: "November 17, 2024"
format: 
  pdf:
    toc: true
    number-sections: true
    colorlinks: true
    geometry:
      - top=20mm
      - left=20mm
      - right=20mm
      - bottom=20mm
    fig-width: 7
    fig-height: 4.5
    fig-pos: 'H'
    keep-tex: false
documentclass: article
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  out.width = "100%"
)

# Load libraries
library(tidyverse)
library(scales)
library(quantmod)
library(xts)
library(zoo)
library(PerformanceAnalytics)
library(kableExtra)
library(moments)

# Global ggplot settings
theme_set(theme_minimal(base_size = 10))
update_geom_defaults("line", list(linewidth = 0.4))

# Set default kable styling for LaTeX/PDF
options(knitr.kable.NA = '')
options(knitr.table.format = "latex")
```

# Introduction

This document implements the single-equity Kelly Criterion backtesting study from Carta & Conversano (2020), Section 3.2.1. We use daily returns of **Banca Intesa (Intesa Sanpaolo)** stock and backtest four Kelly strategy variants:

- **Full Kelly**: $f^*$ (optimal fraction)
- **Half Kelly** (Fractional): $0.5 \times f^*$ 
- **Double Kelly**: $2 \times f^*$ (over-betting)
- **Triple Kelly**: $3 \times f^*$ (aggressive over-betting)

The Kelly Criterion maximizes the expected logarithmic growth rate of wealth for a single asset with continuous probability distribution.

## Theoretical Framework

### Optimal Kelly Fraction for Continuous Returns

For a financial asset with continuous returns, the optimal Kelly fraction $f^*$ that maximizes the expected growth rate is given by (Equation 9 from the paper):

$$
f^* = \frac{\mu - r}{\sigma^2}
$$

where:

- $\mu$ = expected return of the asset
- $r$ = risk-free rate
- $\sigma^2$ = variance of returns

### Wealth Dynamics

The wealth at time $t+1$ is updated using the following formula (Equation 15 from the paper):

$$
W_{t+1} = \left(W_t - (W_t \cdot f^*)\right) \cdot e^{r_f} + (W_t \cdot f^*) \cdot e^{r_t}
$$

where:

- $W_t$ = wealth at time $t$
- $f^*$ = Kelly fraction (or its multiples)
- $r_f$ = risk-free rate per period
- $r_t$ = realized return at time $t$

# Setup and Data Collection

## Download Banca Intesa Data

Following the paper's methodology (Section 3.2.1), we download daily adjusted close prices for **Intesa Sanpaolo (ISP.MI)** from Yahoo Finance for the period January 1, 2007 to December 31, 2018.

```{r download-data, results='hide'}
# Define parameters matching the paper
ticker <- "ISP.MI"
start_date <- "2007-01-01"
end_date <- "2018-12-31"

# Download data from Yahoo Finance
prices_xts <- getSymbols(ticker, 
                         from = start_date,
                         to = end_date,
                         auto.assign = FALSE,
                         warnings = FALSE)

# Extract adjusted close prices
prices <- Ad(prices_xts)
colnames(prices) <- "Price"

# Calculate daily log returns
returns <- diff(log(prices))[-1]
colnames(returns) <- "Return"
```

## Exploratory Data Analysis

```{r eda-returns}
# Convert to tibble
returns_df <- data.frame(
  date = index(returns),
  return = as.numeric(returns)
) %>% as_tibble()

# Summary statistics
summary_stats <- returns_df %>%
  summarise(
    Mean = mean(return, na.rm = TRUE),
    Median = median(return, na.rm = TRUE),
    SD = sd(return, na.rm = TRUE),
    Min = min(return, na.rm = TRUE),
    Max = max(return, na.rm = TRUE),
    Skewness = skewness(return, na.rm = TRUE),
    Kurtosis = kurtosis(return, na.rm = TRUE)
  )

# Display statistics
summary_stats %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value") %>%
  kable(
    caption = "Daily Returns Summary Statistics (2007-2018)",
    digits = 6,
    align = c("l", "r"),
    col.names = c("Statistic", "Value"),
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 9,
    position = "center"
  )
```


### Distribution of Daily Returns

```{r plot-returns-dist, fig.height=3.5}
ggplot(returns_df, aes(x = return)) +
  geom_histogram(aes(y = after_stat(density)), 
                 bins = 50, fill = "#2E86AB", alpha = 0.7) +
  geom_density(color = "#A23B72", linewidth = 0.8) +
  stat_function(fun = dnorm, 
                args = list(mean = mean(returns_df$return, na.rm = TRUE),
                           sd = sd(returns_df$return, na.rm = TRUE)),
                color = "#F18F01", linewidth = 0.8, linetype = "dashed") +
  labs(
    title = "Distribution of Daily Log Returns",
    subtitle = paste(ticker, "- Actual (purple) vs Normal (orange dashed)"),
    x = "Daily Log Return",
    y = "Density"
  ) +
  theme_minimal(base_size = 9)
```

### Time Series of Daily Returns

```{r plot-returns-ts, fig.height=3.5}
ggplot(returns_df, aes(x = date, y = return)) +
  geom_line(color = "#2E86AB", alpha = 0.7, linewidth = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.4) +
  labs(
    title = "Daily Log Returns Over Time",
    subtitle = ticker,
    x = "Date",
    y = "Daily Log Return"
  ) +
  scale_y_continuous(labels = percent) +
  theme_minimal(base_size = 9)
```


# Kelly Criterion Implementation

## Calculate Optimal Kelly Fraction

Following the paper's methodology (Section 3.2.1, page 8), we calculate the optimal Kelly fraction using daily returns.

```{r calculate-kelly}
# Calculate daily statistics
mu_daily <- mean(returns_df$return, na.rm = TRUE)
sigma_daily <- sd(returns_df$return, na.rm = TRUE)
sigma2_daily <- sigma_daily^2

# Assume risk-free rate
rf_annual <- 0.01
rf_daily <- rf_annual / 252

# Calculate optimal Kelly fraction
f_star <- (mu_daily - rf_daily) / sigma2_daily

# Kelly variants
kelly_fractions <- tibble(
  Strategy = c("Half Kelly", "Full Kelly", "Double Kelly", "Triple Kelly"),
  Multiplier = c(0.5, 1.0, 2.0, 3.0),
  Fraction = c(0.5 * f_star, f_star, 2.0 * f_star, 3.0 * f_star)
)

# Display Kelly fractions table
kelly_fractions %>%
  mutate(
    Fraction = round(Fraction, 4),
    `\\% of Wealth` = sprintf("%.2f\\%%", Fraction * 100)
  ) %>%
  kable(
    caption = "Kelly Strategy Fractions",
    align = c("l", "c", "c", "c"),
    booktabs = TRUE,
    escape = FALSE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 9,
    position = "center"
  )
```

**Daily Statistics:**

- Mean return ($\mu$): `r round(mu_daily, 6)`
- Variance ($\sigma^2$): `r round(sigma2_daily, 6)`
- Risk-free rate ($r$): `r round(rf_daily, 6)`
- **Optimal Full Kelly Fraction ($f^*$):** `r round(f_star, 4)`


## Backtest Implementation

We implement the backtesting framework following Equation (15) from the paper. Each strategy starts with initial wealth $W_0 = 1$ and updates wealth daily based on realized returns.

```{r backtest-kelly}
# Define Kelly strategies
strategies <- list(
  "Banca Intesa" = 1.0,
  "Half Kelly" = 0.5 * f_star,
  "Full Kelly" = f_star,
  "Double Kelly" = 2.0 * f_star,
  "Triple Kelly" = 3.0 * f_star
)

# Initialize wealth tracking
initial_wealth <- 1.0
wealth_paths <- matrix(NA, nrow = nrow(returns_df) + 1, 
                      ncol = length(strategies))
colnames(wealth_paths) <- names(strategies)
wealth_paths[1, ] <- initial_wealth

# Backtest each strategy
for (i in 1:nrow(returns_df)) {
  r_t <- returns_df$return[i]
  
  for (j in 1:length(strategies)) {
    f <- strategies[[j]]
    W_t <- wealth_paths[i, j]
    
    W_rf <- (W_t - W_t * f) * exp(rf_daily)
    W_risky <- (W_t * f) * exp(r_t)
    wealth_paths[i + 1, j] <- W_rf + W_risky
  }
}

# Convert to tibble
dates_with_initial <- c(returns_df$date[1] - 1, returns_df$date)

wealth_df <- as_tibble(wealth_paths) %>%
  mutate(date = dates_with_initial) %>%
  pivot_longer(
    cols = -date,
    names_to = "Strategy",
    values_to = "Wealth"
  ) %>%
  mutate(Strategy = factor(Strategy, levels = names(strategies)))
```


# Results and Analysis

## Cumulative Returns Visualization

Replicating Figure 3 from the paper - cumulative wealth evolution for different Kelly strategies.

```{r plot-cumulative-returns, fig.height=5}
ggplot(wealth_df, aes(x = date, y = Wealth, color = Strategy)) +
  geom_line(linewidth = 0.5, alpha = 0.9) +
  scale_y_continuous(
    labels = comma,
    breaks = seq(0, ceiling(max(wealth_df$Wealth, na.rm = TRUE)), by = 0.5)
  ) +
  scale_color_manual(
    values = c(
      "Banca Intesa" = "#000000",
      "Half Kelly" = "#2E86AB",
      "Full Kelly" = "#A23B72",
      "Double Kelly" = "#F18F01",
      "Triple Kelly" = "#06A77D"
    )
  ) +
  labs(
    title = "Cumulative Wealth for Kelly Strategies",
    subtitle = "Banca Intesa (ISP.MI) - Daily Data, 2007-2018",
    x = "Date",
    y = "Wealth",
    caption = "Initial wealth = 1.0. Replicating Carta & Conversano (2020), Figure 3"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```


## Performance Metrics

Calculate key performance metrics replicating Table 5 from the paper.

```{r calculate-performance}
# Calculate metrics
performance_metrics <- wealth_df %>%
  group_by(Strategy) %>%
  summarise(
    `Final Wealth` = last(Wealth),
    `Mean Wealth` = mean(Wealth),
    `Median Wealth` = median(Wealth),
    `SD Wealth` = sd(Wealth),
    `Min Wealth` = min(Wealth),
    `Max Wealth` = max(Wealth)
  )

# Calculate returns series
returns_by_strategy <- wealth_df %>%
  group_by(Strategy) %>%
  arrange(date) %>%
  mutate(Return = c(NA, diff(log(Wealth)))) %>%
  filter(!is.na(Return))

# Additional metrics
additional_metrics <- returns_by_strategy %>%
  group_by(Strategy) %>%
  summarise(
    `CAGR` = (last(Wealth) / first(Wealth))^(252 / n()) - 1,
    `Annual Vol` = sd(Return, na.rm = TRUE) * sqrt(252),
    `Sharpe Ratio` = (mean(Return, na.rm = TRUE) * 252 - rf_annual) / 
                     (sd(Return, na.rm = TRUE) * sqrt(252)),
    `Max Drawdown` = {
      cummax_wealth <- cummax(Wealth)
      drawdown <- (Wealth - cummax_wealth) / cummax_wealth
      min(drawdown)
    }
  )

# Combine metrics
full_metrics <- left_join(performance_metrics, additional_metrics, by = "Strategy")

# Display table
full_metrics %>%
  select(Strategy, `Final Wealth`, CAGR, `Annual Vol`, `Sharpe Ratio`, `Max Drawdown`) %>%
  mutate(
    CAGR = sprintf("%.2f\\%%", CAGR * 100),
    `Annual Vol` = sprintf("%.2f\\%%", `Annual Vol` * 100),
    `Max Drawdown` = sprintf("%.2f\\%%", `Max Drawdown` * 100)
  ) %>%
  kable(
    caption = "Key Performance Metrics (2007-2018)",
    digits = 4,
    align = c("l", "r", "r", "r", "r", "r"),
    booktabs = TRUE,
    escape = FALSE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position", "scale_down"),
    font_size = 8,
    position = "center"
  )
```


## Drawdown Analysis

Analyze the drawdown characteristics of each strategy.

```{r drawdown-analysis, fig.height=4.5}
# Calculate drawdowns
drawdown_df <- wealth_df %>%
  group_by(Strategy) %>%
  arrange(date) %>%
  mutate(
    Cummax = cummax(Wealth),
    Drawdown = (Wealth - Cummax) / Cummax
  )

# Plot drawdowns
ggplot(drawdown_df, aes(x = date, y = Drawdown, color = Strategy)) +
  geom_line(linewidth = 0.5, alpha = 0.9) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(
    values = c(
      "Banca Intesa" = "#000000",
      "Half Kelly" = "#2E86AB",
      "Full Kelly" = "#A23B72",
      "Double Kelly" = "#F18F01",
      "Triple Kelly" = "#06A77D"
    )
  ) +
  labs(
    title = "Drawdown Analysis",
    subtitle = "Banca Intesa (ISP.MI) - Kelly Strategies",
    x = "Date",
    y = "Drawdown (%)"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.title = element_text(face = "bold")
  )
```


## Distribution of Wealth

```{r wealth-distribution, fig.height=4}
ggplot(wealth_df, aes(x = Strategy, y = Wealth, fill = Strategy)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(
    values = c(
      "Banca Intesa" = "#000000",
      "Half Kelly" = "#2E86AB",
      "Full Kelly" = "#A23B72",
      "Double Kelly" = "#F18F01",
      "Triple Kelly" = "#06A77D"
    )
  ) +
  labs(
    title = "Distribution of Wealth by Strategy",
    subtitle = "Box plots showing median, quartiles, and outliers",
    x = "Strategy",
    y = "Wealth"
  ) +
  theme_minimal(base_size = 9) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 25, hjust = 1)
  )
```


# Summary and Conclusions

## Key Findings

```{r summary-table}
full_metrics %>%
  select(Strategy, `Final Wealth`, CAGR, `Annual Vol`, `Sharpe Ratio`, `Max Drawdown`) %>%
  arrange(desc(`Final Wealth`)) %>%
  kable(
    caption = "Kelly Strategies Performance Summary",
    digits = 4,
    align = "lrrrrr",
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position", "scale_down"),
    font_size = 8,
    position = "center"
  )
```

## Interpretation

Based on the backtest results replicating Section 3.2.1 of Carta & Conversano (2020):

1. **Full Kelly Performance**: The Full Kelly strategy achieved a final wealth of **`r round(full_metrics$"Final Wealth"[full_metrics$Strategy == "Full Kelly"], 2)`$\times$** with a CAGR of **`r round(additional_metrics$CAGR[additional_metrics$Strategy == "Full Kelly"] * 100, 2)`%**.

2. **Half Kelly Strategy**: The more conservative Half Kelly achieved a final wealth of **`r round(full_metrics$"Final Wealth"[full_metrics$Strategy == "Half Kelly"], 2)`$\times$** with lower volatility and drawdown.

3. **Over-betting Risk**: Double and Triple Kelly strategies demonstrate the danger of over-betting with severe drawdowns.

4. **Risk-Return Tradeoff**: The Full Kelly strategy provides a Sharpe ratio of **`r round(additional_metrics$"Sharpe Ratio"[additional_metrics$Strategy == "Full Kelly"], 3)`**.

## Data Validation & Reproducibility Notes

**Paper's reported statistics** (Carta & Conversano 2020):

- Mean daily return ($\mu$): 0.000407
- Variance ($\sigma^2$): 0.000712  
- **Optimal Kelly fraction ($f^*$):** 0.5159 (positive - LONG position)

**Our calculated statistics** from Yahoo Finance data (2007-2018):

- Mean daily return ($\mu$): `r round(mu_daily, 6)`
- Variance ($\sigma^2$): `r round(sigma2_daily, 6)`
- **Optimal Kelly fraction ($f^*$):** `r round(f_star, 4)` (NEGATIVE - SHORT position)

### Why the Difference?

The **negative Kelly fraction** indicates that during 2007-2018, Banca Intesa had **negative expected returns** ($\mu < r$). This is historically accurate due to:

1. **2008 Global Financial Crisis**: Italian banks lost 50-70% of value
2. **European Sovereign Debt Crisis (2010-2012)**: Further pressure on Italian banks
3. **Extended bear market**: Banca Intesa stock declined significantly

**Interpretation:** Negative $f^*$ means the Kelly Criterion recommends **SHORT selling** the stock. This is mathematically correct. The paper likely used a different time period with positive returns.

### Methodological Implications

This highlights a **critical limitation** of the Kelly Criterion:

- Requires accurate estimation of $\mu$ and $\sigma^2$
- Highly sensitive to these parameters
- Ex-post estimates may differ from ex-ante expectations

This analysis maintains **methodological reproducibility** while acknowledging different data sources produce different results - a common outcome in empirical finance research.
```